import { Injectable } from '@angular/core';
import { of, throwError } from 'rxjs';
import { AuthService } from './auth.service';
import { StorageService } from './storage-service';
import { buildQueryString, expand, flatten, getWindowOrigin, parseQueryString, staticify } from './utils';
import { OauthService } from './oauth.service';
import { tap } from 'rxjs/operators';
import { SharedService } from './shared.service';
export class RedirectService {
    constructor(authService, storage, oauth, shared) {
        this.authService = authService;
        this.storage = storage;
        this.oauth = oauth;
        this.shared = shared;
    }
    go(url, options, authorizationData, userData) {
        if (window) {
            const qs = buildQueryString(flatten(staticify({ options, authorizationData, userData })));
            this.storage.set('ng2-ui-auth-REDIRECT', qs, '');
            window.open(url, '_self');
            return of({});
        }
        return throwError('Failed to redirect');
    }
    isRedirect() {
        const options = this.storage.get('ng2-ui-auth-REDIRECT');
        if (options) {
            const w = window;
            const windowOrigin = getWindowOrigin(w);
            const optionsObject = expand(parseQueryString(options));
            const redirectUri = optionsObject.redirectUri;
            return redirectUri != null && windowOrigin != null
                && (redirectUri.indexOf(windowOrigin) === 0 || windowOrigin.indexOf(redirectUri) === 0)
                && (w.location.search != null || w.location.hash != null);
        }
    }
    handleRedirect() {
        const options = this.storage.get('ng2-ui-auth-REDIRECT');
        if (options) {
            const w = window;
            const windowOrigin = getWindowOrigin(w);
            const data = expand(parseQueryString(options));
            const optionsObject = data['options'];
            const authorizationData = data['authorizationData'];
            const userData = data['userData'];
            const redirectUri = optionsObject.redirectUri;
            if (redirectUri != null && windowOrigin != null
                && (redirectUri.indexOf(windowOrigin) === 0 || windowOrigin.indexOf(redirectUri) === 0)
                && (w.location.search != null || w.location.hash != null)) {
                const queryParams = w.location.search.substring(1).replace(/\/$/, '');
                const hashParams = w.location.hash.substring(1).replace(/[\/$]/, '');
                const hash = parseQueryString(hashParams);
                const qs = parseQueryString(queryParams);
                const allParams = Object.assign(Object.assign({}, qs), hash);
                if (allParams.error) {
                    throw throwError(allParams.error);
                }
                else {
                    return this.oauth.getProvider(optionsObject)
                        .exchangeForToken(optionsObject, authorizationData, allParams, userData)
                        .pipe(tap(response => {
                        this.shared.setToken(response);
                        this.storage.remove('ng2-ui-auth-REDIRECT');
                    }));
                }
            }
            return throwError('Not at valid redirect URI');
        }
        return throwError('No stored options for redirect');
    }
}
RedirectService.decorators = [
    { type: Injectable }
];
RedirectService.ctorParameters = () => [
    { type: AuthService },
    { type: StorageService },
    { type: OauthService },
    { type: SharedService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkaXJlY3Quc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9wZXRlci9EZXZlbG9wbWVudC9uZzItdWktYXV0aC9wcm9qZWN0cy9uZzItdWktYXV0aC9zcmMvIiwic291cmNlcyI6WyJsaWIvcmVkaXJlY3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBYSxFQUFFLEVBQUUsVUFBVSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFDakQsT0FBTyxFQUFDLGdCQUFnQixFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLGdCQUFnQixFQUFFLFNBQVMsRUFBQyxNQUFNLFNBQVMsQ0FBQztBQUV4RyxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDN0MsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUcvQyxNQUFNLE9BQU8sZUFBZTtJQUUxQixZQUFvQixXQUF3QixFQUFVLE9BQXVCLEVBQ3pELEtBQW1CLEVBQVUsTUFBcUI7UUFEbEQsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFnQjtRQUN6RCxVQUFLLEdBQUwsS0FBSyxDQUFjO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUN0RSxDQUFDO0lBRU0sRUFBRSxDQUFDLEdBQVcsRUFBRSxPQUF3QyxFQUNyRCxpQkFBZ0MsRUFBRSxRQUE2QjtRQUN2RSxJQUFJLE1BQU0sRUFBRTtZQUNWLE1BQU0sRUFBRSxHQUFHLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMs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O2dCQUN6QyxNQUFNLFNBQVMsbUNBQU8sRUFBRSxHQUFLLElBQUksQ0FBQyxDQUFDO2dCQUNuQyxJQUFJLFNBQVMsQ0FBQyxLQUFLLEVBQUU7b0JBQ25CLE1BQU0sVUFBVSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDbkM7cUJBQU07b0JBQ0wsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUM7eUJBQ3pDLGdCQUFnQixDQUFDLGFBQWEsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDO3lCQUN2RSxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO3dCQUNuQixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQzt3QkFDL0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQztvQkFDOUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDUDthQUNGO1lBQ0QsT0FBTyxVQUFVLENBQUMsMkJBQTJCLENBQUMsQ0FBQztTQUNoRDtRQUNELE9BQU8sVUFBVSxDQUFDLGdDQUFnQyxDQUFDLENBQUM7SUFDdEQsQ0FBQzs7O1lBL0RGLFVBQVU7OztZQVJILFdBQVc7WUFDWCxjQUFjO1lBR2QsWUFBWTtZQUVaLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCBvZiwgdGhyb3dFcnJvcn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge0F1dGhTZXJ2aWNlfSBmcm9tICcuL2F1dGguc2VydmljZSc7XG5pbXBvcnQge1N0b3JhZ2VTZXJ2aWNlfSBmcm9tICcuL3N0b3JhZ2Utc2VydmljZSc7XG5pbXBvcnQge2J1aWxkUXVlcnlTdHJpbmcsIGV4cGFuZCwgZmxhdHRlbiwgZ2V0V2luZG93T3JpZ2luLCBwYXJzZVF1ZXJ5U3RyaW5nLCBzdGF0aWNpZnl9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHtJSGllcmFyY2hpY2FsT2JqZWN0LCBJT2F1dGgxT3B0aW9ucywgSU9hdXRoMk9wdGlvbnMsIElPYXV0aE9wdGlvbnMsIElTaW1wbGVPYmplY3R9IGZyb20gJy4vY29uZmlnLWludGVyZmFjZXMnO1xuaW1wb3J0IHtPYXV0aFNlcnZpY2V9IGZyb20gJy4vb2F1dGguc2VydmljZSc7XG5pbXBvcnQge3RhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtTaGFyZWRTZXJ2aWNlfSBmcm9tICcuL3NoYXJlZC5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFJlZGlyZWN0U2VydmljZSB7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBhdXRoU2VydmljZTogQXV0aFNlcnZpY2UsIHByaXZhdGUgc3RvcmFnZTogU3RvcmFnZVNlcnZpY2UsXG4gICAgICAgICAgICAgIHByaXZhdGUgb2F1dGg6IE9hdXRoU2VydmljZSwgcHJpdmF0ZSBzaGFyZWQ6IFNoYXJlZFNlcnZpY2UpIHtcbiAgfVxuXG4gIHB1YmxpYyBnbyh1cmw6IHN0cmluZywgb3B0aW9uczogSU9hdXRoMk9wdGlvbnMgfCBJT2F1dGgxT3B0aW9ucyxcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb25EYXRhOiBJU2ltcGxlT2JqZWN0LCB1c2VyRGF0YTogSUhpZXJhcmNoaWNhbE9iamVjdCk6IE9ic2VydmFibGU8SUhpZXJhcmNoaWNhbE9iamVjdD4ge1xuICAgIGlmICh3aW5kb3cpIHtcbiAgICAgIGNvbnN0IHFzID0gYnVpbGRRdWVyeVN0cmluZyhmbGF0dGVuKHN0YXRpY2lmeSh7b3B0aW9ucywgYXV0aG9yaXphdGlvbkRhdGEsIHVzZXJEYXRhfSkpKTtcbiAgICAgIHRoaXMuc3RvcmFnZS5zZXQoJ25nMi11aS1hdXRoLVJFRElSRUNUJywgcXMsICcnKTtcbiAgICAgIHdpbmRvdy5vcGVuKHVybCwgJ19zZWxmJyk7XG4gICAgICByZXR1cm4gb2Yoe30pO1xuICAgIH1cbiAgICByZXR1cm4gdGhyb3dFcnJvcignRmFpbGVkIHRvIHJlZGlyZWN0Jyk7XG4gIH1cblxuICBwdWJsaWMgaXNSZWRpcmVjdCgpOiBib29sZWFuIHtcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5zdG9yYWdlLmdldCgnbmcyLXVpLWF1dGgtUkVESVJFQ1QnKTtcbiAgICBpZiAob3B0aW9ucykge1xuICAgICAgY29uc3QgdzogV2luZG93ID0gd2luZG93O1xuICAgICAgY29uc3Qgd2luZG93T3JpZ2luID0gZ2V0V2luZG93T3JpZ2luKHcpO1xuICAgICAgY29uc3Qgb3B0aW9uc09iamVjdCA9IGV4cGFuZChwYXJzZVF1ZXJ5U3RyaW5nKG9wdGlvbnMpKSBhcyBJT2F1dGgyT3B0aW9ucztcbiAgICAgIGNvbnN0IHJlZGlyZWN0VXJpID0gb3B0aW9uc09iamVjdC5yZWRpcmVjdFVyaTtcbiAgICAgIHJldHVybiByZWRpcmVjdFVyaSAhPSBudWxsICYmIHdpbmRvd09yaWdpbiAhPSBudWxsXG4gICAgICAgICYmIChyZWRpcmVjdFVyaS5pbmRleE9mKHdpbmRvd09yaWdpbikgPT09IDAgfHwgd2luZG93T3JpZ2luLmluZGV4T2YocmVkaXJlY3RVcmkpID09PSAwKVxuICAgICAgICAmJiAody5sb2NhdGlvbi5zZWFyY2ggIT0gbnVsbCB8fCB3LmxvY2F0aW9uLmhhc2ggIT0gbnVsbCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGhhbmRsZVJlZGlyZWN0KCk6IE9ic2VydmFibGU8SUhpZXJhcmNoaWNhbE9iamVjdD4ge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnN0b3JhZ2UuZ2V0KCduZzItdWktYXV0aC1SRURJUkVDVCcpO1xuICAgIGlmIChvcHRpb25zKSB7XG4gICAgICBjb25zdCB3OiBXaW5kb3cgPSB3aW5kb3c7XG4gICAgICBjb25zdCB3aW5kb3dPcmlnaW4gPSBnZXRXaW5kb3dPcmlnaW4odyk7XG4gICAgICBjb25zdCBkYXRhID0gZXhwYW5kKHBhcnNlUXVlcnlTdHJpbmcob3B0aW9ucykpO1xuICAgICAgY29uc3Qgb3B0aW9uc09iamVjdCA9IGRhdGFbJ29wdGlvbnMnXSBhcyBJT2F1dGhPcHRpb25zO1xuICAgICAgY29uc3QgYXV0aG9yaXphdGlvbkRhdGEgPSBkYXRhWydhdXRob3JpemF0aW9uRGF0YSddIGFzIElTaW1wbGVPYmplY3Q7XG4gICAgICBjb25zdCB1c2VyRGF0YSA9IGRhdGFbJ3VzZXJEYXRhJ10gYXMgSUhpZXJhcmNoaWNhbE9iamVjdDtcbiAgICAgIGNvbnN0IHJlZGlyZWN0VXJpID0gb3B0aW9uc09iamVjdC5yZWRpcmVjdFVyaTtcbiAgICAgIGlmIChyZWRpcmVjdFVyaSAhPSBudWxsICYmIHdpbmRvd09yaWdpbiAhPSBudWxsXG4gICAgICAgICYmIChyZWRpcmVjdFVyaS5pbmRleE9mKHdpbmRvd09yaWdpbikgPT09IDAgfHwgd2luZG93T3JpZ2luLmluZGV4T2YocmVkaXJlY3RVcmkpID09PSAwKVxuICAgICAgICAmJiAody5sb2NhdGlvbi5zZWFyY2ggIT0gbnVsbCB8fCB3LmxvY2F0aW9uLmhhc2ggIT0gbnVsbCkpIHtcbiAgICAgICAgY29uc3QgcXVlcnlQYXJhbXMgPSB3LmxvY2F0aW9uLnNlYXJjaC5zdWJzdHJpbmcoMSkucmVwbGFjZSgvXFwvJC8sICcnKTtcbiAgICAgICAgY29uc3QgaGFzaFBhcmFtcyA9IHcubG9jYXRpb24uaGFzaC5zdWJzdHJpbmcoMSkucmVwbGFjZSgvW1xcLyRdLywgJycpO1xuICAgICAgICBjb25zdCBoYXNoID0gcGFyc2VRdWVyeVN0cmluZyhoYXNoUGFyYW1zKTtcbiAgICAgICAgY29uc3QgcXMgPSBwYXJzZVF1ZXJ5U3RyaW5nKHF1ZXJ5UGFyYW1zKTtcbiAgICAgICAgY29uc3QgYWxsUGFyYW1zID0gey4uLnFzLCAuLi5oYXNofTtcbiAgICAgICAgaWYgKGFsbFBhcmFtcy5lcnJvcikge1xuICAgICAgICAgIHRocm93IHRocm93RXJyb3IoYWxsUGFyYW1zLmVycm9yKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5vYXV0aC5nZXRQcm92aWRlcihvcHRpb25zT2JqZWN0KVxuICAgICAgICAgICAgLmV4Y2hhbmdlRm9yVG9rZW4ob3B0aW9uc09iamVjdCwgYXV0aG9yaXphdGlvbkRhdGEsIGFsbFBhcmFtcywgdXNlckRhdGEpXG4gICAgICAgICAgICAucGlwZSh0YXAocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICB0aGlzLnNoYXJlZC5zZXRUb2tlbihyZXNwb25zZSk7XG4gICAgICAgICAgICAgIHRoaXMuc3RvcmFnZS5yZW1vdmUoJ25nMi11aS1hdXRoLVJFRElSRUNUJyk7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdOb3QgYXQgdmFsaWQgcmVkaXJlY3QgVVJJJyk7XG4gICAgfVxuICAgIHJldHVybiB0aHJvd0Vycm9yKCdObyBzdG9yZWQgb3B0aW9ucyBmb3IgcmVkaXJlY3QnKTtcbiAgfVxuXG59XG4iXX0=