import { Injectable } from '@angular/core';
import { of, throwError } from 'rxjs';
import { StorageService } from './storage-service';
import { buildQueryString, expand, flatten, getWindowOrigin, parseQueryString, staticify } from './utils';
import { tap } from 'rxjs/operators';
import { SharedService } from './shared.service';
export class RedirectService {
    constructor(storage, shared) {
        this.storage = storage;
        this.shared = shared;
    }
    go(url, options, authorizationData, userData) {
        if (window) {
            const qs = buildQueryString(flatten(staticify({ options, authorizationData, userData })));
            this.storage.set('ng2-ui-auth-REDIRECT', qs, '');
            window.open(url, '_self');
            return of({});
        }
        return throwError('Failed to redirect');
    }
    isRedirect() {
        const options = this.storage.get('ng2-ui-auth-REDIRECT');
        if (options) {
            const w = window;
            const windowOrigin = getWindowOrigin(w);
            const optionsObject = expand(parseQueryString(options))['options'];
            const redirectUri = optionsObject.redirectUri;
            return redirectUri != null && windowOrigin != null
                && (redirectUri.indexOf(windowOrigin) === 0 || windowOrigin.indexOf(redirectUri) === 0)
                && (w.location.search != null || w.location.hash != null);
        }
    }
    handleRedirect() {
        const options = this.storage.get('ng2-ui-auth-REDIRECT');
        if (options) {
            const w = window;
            const windowOrigin = getWindowOrigin(w);
            const data = expand(parseQueryString(options));
            const optionsObject = data['options'];
            const authorizationData = data['authorizationData'];
            const userData = data['userData'];
            const redirectUri = optionsObject.redirectUri;
            if (redirectUri != null && windowOrigin != null
                && (redirectUri.indexOf(windowOrigin) === 0 || windowOrigin.indexOf(redirectUri) === 0)
                && (w.location.search != null || w.location.hash != null)) {
                const queryParams = w.location.search.substring(1).replace(/\/$/, '');
                const hashParams = w.location.hash.substring(1).replace(/[\/$]/, '');
                const hash = parseQueryString(hashParams);
                const qs = parseQueryString(queryParams);
                const allParams = Object.assign(Object.assign({}, qs), hash);
                if (allParams.error) {
                    throw throwError(allParams.error);
                }
                else {
                    return this.shared.exchangeForToken(optionsObject, authorizationData, allParams, userData)
                        .pipe(tap(response => {
                        this.shared.setToken(response);
                        this.storage.remove('ng2-ui-auth-REDIRECT');
                    }));
                }
            }
            return throwError('Not at valid redirect URI');
        }
        return throwError('No stored options for redirect');
    }
}
RedirectService.decorators = [
    { type: Injectable }
];
RedirectService.ctorParameters = () => [
    { type: StorageService },
    { type: SharedService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkaXJlY3Quc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9wZXRlci9EZXZlbG9wbWVudC9uZzItdWktYXV0aC9wcm9qZWN0cy9uZzItdWktYXV0aC9zcmMvIiwic291cmNlcyI6WyJsaWIvcmVkaXJlY3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBYSxFQUFFLEVBQUUsVUFBVSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUNqRCxPQUFPLEVBQUMsZ0JBQWdCLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsZ0JBQWdCLEVBQUUsU0FBUyxFQUFDLE1BQU0sU0FBUyxDQUFDO0FBRXhHLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuQyxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sa0JBQWtCLENBQUM7QUFHL0MsTUFBTSxPQUFPLGVBQWU7SUFFMUIsWUFBb0IsT0FBdUIsRUFDdkIsTUFBcUI7UUFEckIsWUFBTyxHQUFQLE9BQU8sQ0FBZ0I7UUFDdkIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUN6QyxDQUFDO0lBRU0sRUFBRSxDQUFDLEdBQVcsRUFBRSxPQUF3QyxFQUNyRCxpQkFBZ0MsRUFBRSxRQUE2QjtRQUN2RSxJQUFJLE1BQU0sRUFBRTtZQUNWLE1BQU0sRUFBRSxHQUFHLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFBQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsUUFBUSxFQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEYsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ2pELE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FB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Q0wsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDO3lCQUN2RixJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO3dCQUNuQixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQzt3QkFDL0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQztvQkFDOUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDUDthQUNGO1lBQ0QsT0FBTyxVQUFVLENBQUMsMkJBQTJCLENBQUMsQ0FBQztTQUNoRDtRQUNELE9BQU8sVUFBVSxDQUFDLGdDQUFnQyxDQUFDLENBQUM7SUFDdEQsQ0FBQzs7O1lBOURGLFVBQVU7OztZQU5ILGNBQWM7WUFJZCxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgb2YsIHRocm93RXJyb3J9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtTdG9yYWdlU2VydmljZX0gZnJvbSAnLi9zdG9yYWdlLXNlcnZpY2UnO1xuaW1wb3J0IHtidWlsZFF1ZXJ5U3RyaW5nLCBleHBhbmQsIGZsYXR0ZW4sIGdldFdpbmRvd09yaWdpbiwgcGFyc2VRdWVyeVN0cmluZywgc3RhdGljaWZ5fSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7SUhpZXJhcmNoaWNhbE9iamVjdCwgSU9hdXRoMU9wdGlvbnMsIElPYXV0aDJPcHRpb25zLCBJT2F1dGhPcHRpb25zLCBJU2ltcGxlT2JqZWN0fSBmcm9tICcuL2NvbmZpZy1pbnRlcmZhY2VzJztcbmltcG9ydCB7dGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1NoYXJlZFNlcnZpY2V9IGZyb20gJy4vc2hhcmVkLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUmVkaXJlY3RTZXJ2aWNlIHtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHN0b3JhZ2U6IFN0b3JhZ2VTZXJ2aWNlLFxuICAgICAgICAgICAgICBwcml2YXRlIHNoYXJlZDogU2hhcmVkU2VydmljZSkge1xuICB9XG5cbiAgcHVibGljIGdvKHVybDogc3RyaW5nLCBvcHRpb25zOiBJT2F1dGgyT3B0aW9ucyB8IElPYXV0aDFPcHRpb25zLFxuICAgICAgICAgICAgYXV0aG9yaXphdGlvbkRhdGE6IElTaW1wbGVPYmplY3QsIHVzZXJEYXRhOiBJSGllcmFyY2hpY2FsT2JqZWN0KTogT2JzZXJ2YWJsZTxJSGllcmFyY2hpY2FsT2JqZWN0PiB7XG4gICAgaWYgKHdpbmRvdykge1xuICAgICAgY29uc3QgcXMgPSBidWlsZFF1ZXJ5U3RyaW5nKGZsYXR0ZW4oc3RhdGljaWZ5KHtvcHRpb25zLCBhdXRob3JpemF0aW9uRGF0YSwgdXNlckRhdGF9KSkpO1xuICAgICAgdGhpcy5zdG9yYWdlLnNldCgnbmcyLXVpLWF1dGgtUkVESVJFQ1QnLCBxcywgJycpO1xuICAgICAgd2luZG93Lm9wZW4odXJsLCAnX3NlbGYnKTtcbiAgICAgIHJldHVybiBvZih7fSk7XG4gICAgfVxuICAgIHJldHVybiB0aHJvd0Vycm9yKCdGYWlsZWQgdG8gcmVkaXJlY3QnKTtcbiAgfVxuXG4gIHB1YmxpYyBpc1JlZGlyZWN0KCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnN0b3JhZ2UuZ2V0KCduZzItdWktYXV0aC1SRURJUkVDVCcpO1xuICAgIGlmIChvcHRpb25zKSB7XG4gICAgICBjb25zdCB3OiBXaW5kb3cgPSB3aW5kb3c7XG4gICAgICBjb25zdCB3aW5kb3dPcmlnaW4gPSBnZXRXaW5kb3dPcmlnaW4odyk7XG4gICAgICBjb25zdCBvcHRpb25zT2JqZWN0ID0gZXhwYW5kKHBhcnNlUXVlcnlTdHJpbmcob3B0aW9ucykpWydvcHRpb25zJ10gYXMgSU9hdXRoMk9wdGlvbnM7XG4gICAgICBjb25zdCByZWRpcmVjdFVyaSA9IG9wdGlvbnNPYmplY3QucmVkaXJlY3RVcmk7XG4gICAgICByZXR1cm4gcmVkaXJlY3RVcmkgIT0gbnVsbCAmJiB3aW5kb3dPcmlnaW4gIT0gbnVsbFxuICAgICAgICAmJiAocmVkaXJlY3RVcmkuaW5kZXhPZih3aW5kb3dPcmlnaW4pID09PSAwIHx8IHdpbmRvd09yaWdpbi5pbmRleE9mKHJlZGlyZWN0VXJpKSA9PT0gMClcbiAgICAgICAgJiYgKHcubG9jYXRpb24uc2VhcmNoICE9IG51bGwgfHwgdy5sb2NhdGlvbi5oYXNoICE9IG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVSZWRpcmVjdCgpOiBPYnNlcnZhYmxlPElIaWVyYXJjaGljYWxPYmplY3Q+IHtcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5zdG9yYWdlLmdldCgnbmcyLXVpLWF1dGgtUkVESVJFQ1QnKTtcbiAgICBpZiAob3B0aW9ucykge1xuICAgICAgY29uc3QgdzogV2luZG93ID0gd2luZG93O1xuICAgICAgY29uc3Qgd2luZG93T3JpZ2luID0gZ2V0V2luZG93T3JpZ2luKHcpO1xuICAgICAgY29uc3QgZGF0YSA9IGV4cGFuZChwYXJzZVF1ZXJ5U3RyaW5nKG9wdGlvbnMpKTtcbiAgICAgIGNvbnN0IG9wdGlvbnNPYmplY3QgPSBkYXRhWydvcHRpb25zJ10gYXMgSU9hdXRoT3B0aW9ucztcbiAgICAgIGNvbnN0IGF1dGhvcml6YXRpb25EYXRhID0gZGF0YVsnYXV0aG9yaXphdGlvbkRhdGEnXSBhcyBJU2ltcGxlT2JqZWN0O1xuICAgICAgY29uc3QgdXNlckRhdGEgPSBkYXRhWyd1c2VyRGF0YSddIGFzIElIaWVyYXJjaGljYWxPYmplY3Q7XG4gICAgICBjb25zdCByZWRpcmVjdFVyaSA9IG9wdGlvbnNPYmplY3QucmVkaXJlY3RVcmk7XG4gICAgICBpZiAocmVkaXJlY3RVcmkgIT0gbnVsbCAmJiB3aW5kb3dPcmlnaW4gIT0gbnVsbFxuICAgICAgICAmJiAocmVkaXJlY3RVcmkuaW5kZXhPZih3aW5kb3dPcmlnaW4pID09PSAwIHx8IHdpbmRvd09yaWdpbi5pbmRleE9mKHJlZGlyZWN0VXJpKSA9PT0gMClcbiAgICAgICAgJiYgKHcubG9jYXRpb24uc2VhcmNoICE9IG51bGwgfHwgdy5sb2NhdGlvbi5oYXNoICE9IG51bGwpKSB7XG4gICAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0gdy5sb2NhdGlvbi5zZWFyY2guc3Vic3RyaW5nKDEpLnJlcGxhY2UoL1xcLyQvLCAnJyk7XG4gICAgICAgIGNvbnN0IGhhc2hQYXJhbXMgPSB3LmxvY2F0aW9uLmhhc2guc3Vic3RyaW5nKDEpLnJlcGxhY2UoL1tcXC8kXS8sICcnKTtcbiAgICAgICAgY29uc3QgaGFzaCA9IHBhcnNlUXVlcnlTdHJpbmcoaGFzaFBhcmFtcyk7XG4gICAgICAgIGNvbnN0IHFzID0gcGFyc2VRdWVyeVN0cmluZyhxdWVyeVBhcmFtcyk7XG4gICAgICAgIGNvbnN0IGFsbFBhcmFtcyA9IHsuLi5xcywgLi4uaGFzaH07XG4gICAgICAgIGlmIChhbGxQYXJhbXMuZXJyb3IpIHtcbiAgICAgICAgICB0aHJvdyB0aHJvd0Vycm9yKGFsbFBhcmFtcy5lcnJvcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc2hhcmVkLmV4Y2hhbmdlRm9yVG9rZW4ob3B0aW9uc09iamVjdCwgYXV0aG9yaXphdGlvbkRhdGEsIGFsbFBhcmFtcywgdXNlckRhdGEpXG4gICAgICAgICAgICAucGlwZSh0YXAocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgICB0aGlzLnNoYXJlZC5zZXRUb2tlbihyZXNwb25zZSk7XG4gICAgICAgICAgICAgIHRoaXMuc3RvcmFnZS5yZW1vdmUoJ25nMi11aS1hdXRoLVJFRElSRUNUJyk7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdOb3QgYXQgdmFsaWQgcmVkaXJlY3QgVVJJJyk7XG4gICAgfVxuICAgIHJldHVybiB0aHJvd0Vycm9yKCdObyBzdG9yZWQgb3B0aW9ucyBmb3IgcmVkaXJlY3QnKTtcbiAgfVxuXG59XG4iXX0=