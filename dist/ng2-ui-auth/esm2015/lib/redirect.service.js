import { Injectable } from '@angular/core';
import { of, throwError } from 'rxjs';
import { AuthService } from './auth.service';
import { StorageService } from './storage-service';
import { buildQueryString, expand, flatten, getWindowOrigin, parseQueryString, staticify } from './utils';
import { OauthService } from './oauth.service';
import { tap } from 'rxjs/operators';
import { SharedService } from './shared.service';
export class RedirectService {
    constructor(authService, storage, oauth, shared) {
        this.authService = authService;
        this.storage = storage;
        this.oauth = oauth;
        this.shared = shared;
    }
    go(url, options, authorizationData, userData) {
        if (window) {
            const qs = buildQueryString(flatten(staticify({ options, authorizationData, userData })));
            this.storage.set('ng2-ui-auth-REDIRECT', qs, '');
            window.open(url, '_self');
            return of({});
        }
        return throwError('Failed to redirect');
    }
    isRedirect() {
        const options = this.storage.get('ng2-ui-auth-REDIRECT');
        if (options) {
            const w = window;
            const windowOrigin = getWindowOrigin(w);
            const optionsObject = expand(parseQueryString(options));
            const redirectUri = optionsObject.redirectUri;
            return redirectUri != null && windowOrigin != null
                && (redirectUri.indexOf(windowOrigin) === 0 || windowOrigin.indexOf(redirectUri) === 0)
                && (w.location.search != null || w.location.hash != null);
        }
    }
    handleRedirect() {
        const options = this.storage.get('ng2-ui-auth-REDIRECT');
        if (options) {
            const w = window;
            const windowOrigin = getWindowOrigin(w);
            const data = expand(parseQueryString(options));
            const optionsObject = data['options'];
            const authorizationData = data['authorizationData'];
            const userData = data['userData'];
            const redirectUri = optionsObject.redirectUri;
            if (redirectUri != null && windowOrigin != null
                && (redirectUri.indexOf(windowOrigin) === 0 || windowOrigin.indexOf(redirectUri) === 0)
                && (w.location.search != null || w.location.hash != null)) {
                const queryParams = w.location.search.substring(1).replace(/\/$/, '');
                const hashParams = w.location.hash.substring(1).replace(/[\/$]/, '');
                const hash = parseQueryString(hashParams);
                const qs = parseQueryString(queryParams);
                const allParams = Object.assign(Object.assign({}, qs), hash);
                if (allParams.error) {
                    throw throwError(allParams.error);
                }
                else {
                    return this.oauth.getProvider(optionsObject)
                        .exchangeForToken(optionsObject, authorizationData, allParams, userData)
                        .pipe(tap(response => {
                        this.shared.setToken(response);
                        this.storage.remove('ng2-ui-auth-REDIRECT');
                    }));
                }
            }
            return throwError('Not at valid redirect URI');
        }
        return throwError('No stored options for redirect');
    }
}
RedirectService.decorators = [
    { type: Injectable }
];
RedirectService.ctorParameters = () => [
    { type: AuthService },
    { type: StorageService },
    { type: OauthService },
    { type: SharedService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkaXJlY3Quc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9wZXRlci9EZXZlbG9wbWVudC9uZzItdWktYXV0aC9wcm9qZWN0cy9uZzItdWktYXV0aC9zcmMvIiwic291cmNlcyI6WyJsaWIvcmVkaXJlY3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBYSxFQUFFLEVBQUUsVUFBVSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFDakQsT0FBTyxFQUFDLGdCQUFnQixFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLGdCQUFnQixFQUFFLFNBQVMsRUFBQyxNQUFNLFNBQVMsQ0FBQztBQUt4RyxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDN0MsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUcvQyxNQUFNLE9BQU8sZUFBZTtJQUUxQixZQUFvQixXQUF3QixFQUFVLE9BQXVCLEVBQ3pELEtBQW1CLEVBQVUsTUFBcUI7UUFEbEQsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFBVSxZQUFPLEdBQVAsT0FBTyxDQUFnQjtRQUN6RCxVQUFLLEdBQUwsS0FBSyxDQUFjO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBZTtJQUN0RSxDQUFDO0lBRU0sRUFBRSxDQUFDLEdBQVcsRUFBRSxPQUF3QyxFQUNyRCxpQkFBZ0MsRUFBRSxRQUE2QjtRQUN2RSxJQUFJLE1BQU0sRUFBRTtZQUNWLE1BQU0sRUFBRSxHQUFHLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMs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O2dCQUN6QyxNQUFNLFNBQVMsbUNBQU8sRUFBRSxHQUFLLElBQUksQ0FBQyxDQUFDO2dCQUNuQyxJQUFJLFNBQVMsQ0FBQyxLQUFLLEVBQUU7b0JBQ25CLE1BQU0sVUFBVSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDbkM7cUJBQU07b0JBQ0wsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUM7eUJBQ3pDLGdCQUFnQixDQUFDLGFBQWEsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDO3lCQUN2RSxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO3dCQUNuQixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQzt3QkFDL0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQztvQkFDOUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDUDthQUNGO1lBQ0QsT0FBTyxVQUFVLENBQUMsMkJBQTJCLENBQUMsQ0FBQztTQUNoRDtRQUNELE9BQU8sVUFBVSxDQUFDLGdDQUFnQyxDQUFDLENBQUM7SUFDdEQsQ0FBQzs7O1lBL0RGLFVBQVU7OztZQVhILFdBQVc7WUFDWCxjQUFjO1lBTWQsWUFBWTtZQUVaLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCBvZiwgdGhyb3dFcnJvcn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge0F1dGhTZXJ2aWNlfSBmcm9tICcuL2F1dGguc2VydmljZSc7XG5pbXBvcnQge1N0b3JhZ2VTZXJ2aWNlfSBmcm9tICcuL3N0b3JhZ2Utc2VydmljZSc7XG5pbXBvcnQge2J1aWxkUXVlcnlTdHJpbmcsIGV4cGFuZCwgZmxhdHRlbiwgZ2V0V2luZG93T3JpZ2luLCBwYXJzZVF1ZXJ5U3RyaW5nLCBzdGF0aWNpZnl9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHtJSGllcmFyY2hpY2FsT2JqZWN0LCBJT2F1dGgxT3B0aW9ucywgSU9hdXRoMk9wdGlvbnMsIElPYXV0aE9wdGlvbnMsIElTaW1wbGVPYmplY3R9IGZyb20gJy4vY29uZmlnLWludGVyZmFjZXMnO1xuaW1wb3J0IHtIdHRwQ2xpZW50fSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge1BvcHVwU2VydmljZX0gZnJvbSAnLi9wb3B1cC5zZXJ2aWNlJztcbmltcG9ydCB7Q29uZmlnU2VydmljZX0gZnJvbSAnLi9jb25maWcuc2VydmljZSc7XG5pbXBvcnQge09hdXRoU2VydmljZX0gZnJvbSAnLi9vYXV0aC5zZXJ2aWNlJztcbmltcG9ydCB7dGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1NoYXJlZFNlcnZpY2V9IGZyb20gJy4vc2hhcmVkLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUmVkaXJlY3RTZXJ2aWNlIHtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGF1dGhTZXJ2aWNlOiBBdXRoU2VydmljZSwgcHJpdmF0ZSBzdG9yYWdlOiBTdG9yYWdlU2VydmljZSxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBvYXV0aDogT2F1dGhTZXJ2aWNlLCBwcml2YXRlIHNoYXJlZDogU2hhcmVkU2VydmljZSkge1xuICB9XG5cbiAgcHVibGljIGdvKHVybDogc3RyaW5nLCBvcHRpb25zOiBJT2F1dGgyT3B0aW9ucyB8IElPYXV0aDFPcHRpb25zLFxuICAgICAgICAgICAgYXV0aG9yaXphdGlvbkRhdGE6IElTaW1wbGVPYmplY3QsIHVzZXJEYXRhOiBJSGllcmFyY2hpY2FsT2JqZWN0KTogT2JzZXJ2YWJsZTxJSGllcmFyY2hpY2FsT2JqZWN0PiB7XG4gICAgaWYgKHdpbmRvdykge1xuICAgICAgY29uc3QgcXMgPSBidWlsZFF1ZXJ5U3RyaW5nKGZsYXR0ZW4oc3RhdGljaWZ5KHtvcHRpb25zLCBhdXRob3JpemF0aW9uRGF0YSwgdXNlckRhdGF9KSkpO1xuICAgICAgdGhpcy5zdG9yYWdlLnNldCgnbmcyLXVpLWF1dGgtUkVESVJFQ1QnLCBxcywgJycpO1xuICAgICAgd2luZG93Lm9wZW4odXJsLCAnX3NlbGYnKTtcbiAgICAgIHJldHVybiBvZih7fSk7XG4gICAgfVxuICAgIHJldHVybiB0aHJvd0Vycm9yKCdGYWlsZWQgdG8gcmVkaXJlY3QnKTtcbiAgfVxuXG4gIHB1YmxpYyBpc1JlZGlyZWN0KCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnN0b3JhZ2UuZ2V0KCduZzItdWktYXV0aC1SRURJUkVDVCcpO1xuICAgIGlmIChvcHRpb25zKSB7XG4gICAgICBjb25zdCB3OiBXaW5kb3cgPSB3aW5kb3c7XG4gICAgICBjb25zdCB3aW5kb3dPcmlnaW4gPSBnZXRXaW5kb3dPcmlnaW4odyk7XG4gICAgICBjb25zdCBvcHRpb25zT2JqZWN0ID0gZXhwYW5kKHBhcnNlUXVlcnlTdHJpbmcob3B0aW9ucykpIGFzIElPYXV0aDJPcHRpb25zO1xuICAgICAgY29uc3QgcmVkaXJlY3RVcmkgPSBvcHRpb25zT2JqZWN0LnJlZGlyZWN0VXJpO1xuICAgICAgcmV0dXJuIHJlZGlyZWN0VXJpICE9IG51bGwgJiYgd2luZG93T3JpZ2luICE9IG51bGxcbiAgICAgICAgJiYgKHJlZGlyZWN0VXJpLmluZGV4T2Yod2luZG93T3JpZ2luKSA9PT0gMCB8fCB3aW5kb3dPcmlnaW4uaW5kZXhPZihyZWRpcmVjdFVyaSkgPT09IDApXG4gICAgICAgICYmICh3LmxvY2F0aW9uLnNlYXJjaCAhPSBudWxsIHx8IHcubG9jYXRpb24uaGFzaCAhPSBudWxsKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgaGFuZGxlUmVkaXJlY3QoKTogT2JzZXJ2YWJsZTxJSGllcmFyY2hpY2FsT2JqZWN0PiB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuc3RvcmFnZS5nZXQoJ25nMi11aS1hdXRoLVJFRElSRUNUJyk7XG4gICAgaWYgKG9wdGlvbnMpIHtcbiAgICAgIGNvbnN0IHc6IFdpbmRvdyA9IHdpbmRvdztcbiAgICAgIGNvbnN0IHdpbmRvd09yaWdpbiA9IGdldFdpbmRvd09yaWdpbih3KTtcbiAgICAgIGNvbnN0IGRhdGEgPSBleHBhbmQocGFyc2VRdWVyeVN0cmluZyhvcHRpb25zKSk7XG4gICAgICBjb25zdCBvcHRpb25zT2JqZWN0ID0gZGF0YVsnb3B0aW9ucyddIGFzIElPYXV0aE9wdGlvbnM7XG4gICAgICBjb25zdCBhdXRob3JpemF0aW9uRGF0YSA9IGRhdGFbJ2F1dGhvcml6YXRpb25EYXRhJ10gYXMgSVNpbXBsZU9iamVjdDtcbiAgICAgIGNvbnN0IHVzZXJEYXRhID0gZGF0YVsndXNlckRhdGEnXSBhcyBJSGllcmFyY2hpY2FsT2JqZWN0O1xuICAgICAgY29uc3QgcmVkaXJlY3RVcmkgPSBvcHRpb25zT2JqZWN0LnJlZGlyZWN0VXJpO1xuICAgICAgaWYgKHJlZGlyZWN0VXJpICE9IG51bGwgJiYgd2luZG93T3JpZ2luICE9IG51bGxcbiAgICAgICAgJiYgKHJlZGlyZWN0VXJpLmluZGV4T2Yod2luZG93T3JpZ2luKSA9PT0gMCB8fCB3aW5kb3dPcmlnaW4uaW5kZXhPZihyZWRpcmVjdFVyaSkgPT09IDApXG4gICAgICAgICYmICh3LmxvY2F0aW9uLnNlYXJjaCAhPSBudWxsIHx8IHcubG9jYXRpb24uaGFzaCAhPSBudWxsKSkge1xuICAgICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHcubG9jYXRpb24uc2VhcmNoLnN1YnN0cmluZygxKS5yZXBsYWNlKC9cXC8kLywgJycpO1xuICAgICAgICBjb25zdCBoYXNoUGFyYW1zID0gdy5sb2NhdGlvbi5oYXNoLnN1YnN0cmluZygxKS5yZXBsYWNlKC9bXFwvJF0vLCAnJyk7XG4gICAgICAgIGNvbnN0IGhhc2ggPSBwYXJzZVF1ZXJ5U3RyaW5nKGhhc2hQYXJhbXMpO1xuICAgICAgICBjb25zdCBxcyA9IHBhcnNlUXVlcnlTdHJpbmcocXVlcnlQYXJhbXMpO1xuICAgICAgICBjb25zdCBhbGxQYXJhbXMgPSB7Li4ucXMsIC4uLmhhc2h9O1xuICAgICAgICBpZiAoYWxsUGFyYW1zLmVycm9yKSB7XG4gICAgICAgICAgdGhyb3cgdGhyb3dFcnJvcihhbGxQYXJhbXMuZXJyb3IpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB0aGlzLm9hdXRoLmdldFByb3ZpZGVyKG9wdGlvbnNPYmplY3QpXG4gICAgICAgICAgICAuZXhjaGFuZ2VGb3JUb2tlbihvcHRpb25zT2JqZWN0LCBhdXRob3JpemF0aW9uRGF0YSwgYWxsUGFyYW1zLCB1c2VyRGF0YSlcbiAgICAgICAgICAgIC5waXBlKHRhcChyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMuc2hhcmVkLnNldFRva2VuKHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgdGhpcy5zdG9yYWdlLnJlbW92ZSgnbmcyLXVpLWF1dGgtUkVESVJFQ1QnKTtcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ05vdCBhdCB2YWxpZCByZWRpcmVjdCBVUkknKTtcbiAgICB9XG4gICAgcmV0dXJuIHRocm93RXJyb3IoJ05vIHN0b3JlZCBvcHRpb25zIGZvciByZWRpcmVjdCcpO1xuICB9XG5cbn1cbiJdfQ==